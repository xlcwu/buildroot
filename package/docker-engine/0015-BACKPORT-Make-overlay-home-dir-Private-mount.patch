From c448abc5350da59110b7b24eb796f488c29a4c9f Mon Sep 17 00:00:00 2001
From: Antonio Murdaca <runcom@redhat.com>
Date: Mon, 18 Apr 2016 11:25:57 +0200
Subject: [PATCH 15/41] BACKPORT: Make overlay home dir Private mount

Upstream reference: https://github.com/docker/docker/pull/22069

Signed-off-by: Antonio Murdaca <runcom@redhat.com>
---
 daemon/graphdriver/overlay/overlay.go | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/daemon/graphdriver/overlay/overlay.go b/daemon/graphdriver/overlay/overlay.go
index 59131bb..d521db2 100644
--- a/daemon/graphdriver/overlay/overlay.go
+++ b/daemon/graphdriver/overlay/overlay.go
@@ -18,6 +18,7 @@ import (
 	"github.com/docker/docker/pkg/archive"
 	"github.com/docker/docker/pkg/chrootarchive"
 	"github.com/docker/docker/pkg/idtools"
+	"github.com/docker/docker/pkg/mount"
 
 	"github.com/opencontainers/runc/libcontainer/label"
 )
@@ -150,6 +151,10 @@ func Init(home string, options []string, uidMaps, gidMaps []idtools.IDMap) (grap
 		return nil, err
 	}
 
+	if err := mount.MakePrivate(home); err != nil {
+		return nil, err
+	}
+
 	d := &Driver{
 		home:    home,
 		active:  make(map[string]*ActiveMount),
@@ -225,7 +230,7 @@ func (d *Driver) GetMetadata(id string) (map[string]string, error) {
 // Cleanup simply returns nil and do not change the existing filesystem.
 // This is required to satisfy the graphdriver.Driver interface.
 func (d *Driver) Cleanup() error {
-	return nil
+	return mount.Unmount(d.home)
 }
 
 // Create is used to create the upper, lower, and merge directories required for overlay fs for a given id.
-- 
1.9.1

